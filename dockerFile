# Stage 1: Build the UI (Next.js application)
FROM node:24.11.1-alpine AS builder-ui

WORKDIR /app/ui

# Copy package.json and package-lock.json first to leverage Docker cache
COPY timetable-ui/package.json timetable-ui/package-lock.json ./
RUN npm ci

# Copy the rest of the UI source code
COPY timetable-ui .

# Set the API URL for the Next.js app during build
ENV NEXT_PUBLIC_API_URL=http://localhost:3000
RUN npm run build

# Stage 2: Prepare the Server (Python FastAPI application)
FROM python:3.13-bookworm AS builder-server

WORKDIR /app/server

# Copy requirements.txt and install Python dependencies
COPY timetable-server/requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copy the rest of the server source code
COPY timetable-server .

# Stage 3: Final image combining UI and Server
FROM python:3.13-bookworm AS final

WORKDIR /app

# Install Nginx
RUN DEBIAN_FRONTEND=noninteractive apt-get update && apt-get install -y --no-install-recommends perl libterm-readline-gnu-perl nginx && rm -rf /var/lib/apt/lists/*

# Copy Nginx configuration
#COPY nginx.conf /etc/nginx/sites-enabled/default
COPY nginx.conf /etc/nginx/nginx.conf
# Remove default nginx config
# RUN rm /etc/nginx/conf.d/default.conf

# Copy built UI assets from the builder-ui stage
COPY --from=builder-ui /app/ui/out /app/ui/out

# Copy server code and installed dependencies from the builder-server stage
# Ensure all server files are copied, including subdirectories
COPY --from=builder-server /app/server /app/server
COPY --from=builder-server /usr/local/lib/python3.13/site-packages /usr/local/lib/python3.13/site-packages
COPY --from=builder-server /usr/local/bin/uvicorn /usr/local/bin/uvicorn
COPY --from=builder-server /usr/local/bin/fastapi /usr/local/bin/fastapi


# Expose the UI port
EXPOSE 8080

# Command to run both Uvicorn (FastAPI) and Nginx
# Uvicorn runs in the background, Nginx runs in the foreground
# Use a simple shell script to manage this
RUN chmod +x /app/server/server.py

CMD ["bash", "-c", "uvicorn server:app --host 0.0.0.0 --port 8000 --app-dir /app/server & nginx -g 'daemon off;'"]